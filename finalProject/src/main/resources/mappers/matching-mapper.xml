<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="MatchingMapper">


<resultMap type="matching" id="matchingResultSet">
<result column="MA_NO" property="maNo"/>
<result column="USER_NO" property="userNo"/>
<result column="GROUP_NO" property="groupNo"/>
<result column="RANDOM" property="random"/>
<result column="GENDER" property="gender"/>
<result column="SUBJECT" property="subject"/>
<result column="AREA" property="area"/>
<result column="FEE" property="fee"/>
<result column="PEOPLE" property="people"/>
<result column="CHIEF" property="chief"/>
<result column="STATUS" property="status"/>
<result column="MA_DAY" property="maDay"/>
<result column="ENROLLDATE" property="enrollDate"/>
<result column="ALERT" property="alert" />
<result column="YEAR" property="sYear"/>
<result column="URL" property="url"/>
</resultMap>

<!-- 같은 과목으로 매칭이 있는지 확인 -->
<select id="checkSubject" resultType="_int">
SELECT COUNT(*)
FROM MATCHING
WHERE USER_NO = #{userNo}
AND SUBJECT = #{subject}
AND STATUS = 'Y'
</select>

<!-- 동일한 조건으로 등록된 매칭이 있는지 확인 -->
<select id="checkMatching"  resultType="_int">
SELECT M.GROUP_NO 
FROM STUDENT S, 
(SELECT USER_NO,GROUP_NO
FROM MATCHING
WHERE RANDOM = 'Y'
<choose>
<when  test='gender.equals("S")'>
AND GENDER = #{sGender}
</when>
<otherwise>
AND GENDER = 'R'
</otherwise>
</choose>
AND SUBJECT = #{subject}
AND AREA = #{area}
AND MA_DAY LIKE '%'||#{maDay}||'%'
AND FEE <![CDATA[ <= ]]> #{fee}+10000
AND FEE <![CDATA[ >= ]]> #{fee}-10000
AND PEOPLE = #{people}
AND CHIEF ='Y'
) M
WHERE S.USER_NO = M.USER_NO
AND YEAR = #{sYear}
</select>





<!-- 매칭 등록  -->
<insert id="insertMatching" parameterType="matching">
INSERT INTO MATCHING(
					MA_NO,
					GROUP_NO,
					USER_NO,
					RANDOM,
					GENDER,
					SUBJECT,
					AREA,
					FEE,
					PEOPLE,
					CHIEF,
					MA_DAY,
					ALERT,
					URL,
					STATUS
					)
			VALUES(
			SEQ_MANO.NEXTVAL,
			SEQ_MANO.CURRVAL,
			#{userNo},
			#{random},
			<choose>
			<when test='gender.equals("S")'>
			#{sGender},
			</when>
			<otherwise>
			#{gender},
			</otherwise>
			</choose>
			#{subject},
			#{area},
			#{fee},
			#{people},
			'Y',
			#{maDay},
			'N',
			'N',
			<choose>
			<when test='random.equals("N")'>
			'C'
			</when>
			<otherwise>
			'Y'
			</otherwise>
			</choose>
			
			)
</insert>


<!-- 등록된 매칭에 조인 -->
<insert id="joinMatching" parameterType="matching">
	INSERT INTO MATCHING(
					MA_NO,
					GROUP_NO,
					USER_NO,
					RANDOM,
					GENDER,
					SUBJECT,
					AREA,
					FEE,
					PEOPLE,
					CHIEF,
					MA_DAY,
					ALERT,
					URL,
					STATUS
					)
			VALUES(
			SEQ_MANO.NEXTVAL,
			#{groupNo},
			#{userNo},
			#{random},
			<choose>
			<when test='#{gender}.equals("S")'>
			#{sGender},
			</when>
			<otherwise>
			#{gender},
			</otherwise>
			</choose>
			#{subject},
			#{area},
			#{fee},
			#{people},
			'N',
			#{maDay},
			'N',
			'N',
			'Y'
			)

</insert>

<!-- 매칭인원수 확인을 위한 카운팅 -->
<select id="countMatching" resultType="_int">
	SELECT COUNT(*)
FROM MATCHING
WHERE GROUP_NO = #{groupNo}
</select>

<!-- 매칭완료되면 status를 c로변경 -->
<update id="completeMatching" parameterType="matching">
	UPDATE MATCHING
	SET STATUS ='C'
	WHERE GROUP_NO =#{groupNo}
</update>

<!-- 매칭완료된 인원들의 리스트뽑기 -->
<select id="completeMatchingList" resultMap="matchingResultSet">
SELECT USER_NO,GROUP_NO,SUBJECT,FEE,MA_DAY,AREA
FROM MATCHING
WHERE GROUP_NO = #{groupNo}
ORDER BY CHIEF DESC
</select>

<!-- 알람페이지에서 보여줄 리스트 -->
<select id="alarmList" resultMap="matchingResultSet">
SELECT MA_NO,GROUP_NO,SUBJECT,PEOPLE,GENDER,FEE,ENROLLDATE,STATUS,RANDOM
FROM MATCHING
WHERE USER_NO=#{userNo}
</select>

<!-- 알람을 위한 select -->
<select id="matchingAlarm" resultType="_int">
SELECT COUNT(*)
FROM MATCHING
WHERE USER_NO = #{userNo}
AND STATUS = 'C' 
AND RANDOM = 'Y'
</select>

<select id="matchingAlarm2" resultType="_int">
SELECT MA_NO
FROM(
SELECT MA_NO
FROM MATCHING
WHERE USER_NO = #{userNo}
AND STATUS = 'C'
AND ALERT = 'N'
AND RANDOM = 'Y'
ORDER BY ENROLLDATE
)
WHERE ROWNUM = 1
</select>

<update id="updateAlarm" parameterType="matching">
	UPDATE MATCHING
	SET ALERT ='Y'
	WHERE MA_NO = #{maNo}

</update>

<select id="tlistCheck" resultType="_int">
SELECT COUNT(*)
FROM MATCHING
WHERE USER_NO = #{userNo}
AND STATUS = 'C'
</select>

<select id="selectComparison" resultMap="matchingResultSet">
 SELECT SUBJECT,YEAR,AREA,FEE
FROM MATCHING M 
JOIN STUDENT S
USING(USER_NO)
WHERE USER_NO =#{userNo}
AND M.STATUS = 'C'
</select>


<delete id="deleteMatching" parameterType="matching"> 
		DELETE FROM MATCHING
		WHERE MA_NO = #{maNo}	
</delete>
</mapper>